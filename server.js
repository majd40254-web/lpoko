// ============================================
// Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø­Ø¯ÙŠØ«Ø© - Modern Technology Center
// Backend Server with OpenAI ChatGPT API
// ============================================

const express = require('express');
const cors = require('cors');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// ============================================
// OpenAI API Configuration (SECURE - Server Side Only)
// ============================================
const OPENAI_API_KEY = '';
const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';

// ============================================
// System Prompt for the AI Assistant
// ============================================
const SYSTEM_PROMPT = `Ø£Ù†Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù€ "Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø­Ø¯ÙŠØ«Ø©" Ø§Ù„Ù…Ù…Ù„ÙˆÙƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø³Ø§Ù…Ø± Ø§Ù„Ù‚ØµØ±Ø§ÙˆÙŠ.

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²:
- Ø§Ù„Ø§Ø³Ù…: Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
- Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø³Ø§Ù…Ø± Ø§Ù„Ù‚ØµØ±Ø§ÙˆÙŠ
- ÙˆØ§ØªØ³Ø§Ø¨: 0522456676
- Ø¬ÙˆØ§Ù„: 0598460552
- Ø§Ù„Ù…ÙˆÙ‚Ø¹: https://maps.app.goo.gl/oka7VJgmVfAVXjJ89

Ø®Ø¯Ù…Ø§ØªÙ†Ø§ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:
1. Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (CCTV) - ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ØªØ·ÙˆØ±Ø© Ø¨Ø¯Ù‚Ø© 4K Ù…Ø¹ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù† Ø¨Ø¹Ø¯ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©
2. Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© - Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù†Ø°Ø§Ø± Ø°ÙƒÙŠØ© ÙˆØ£Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„
3. Ø£Ù†Ø¸Ù…Ø© Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø­Ø±ÙŠÙ‚ - ØµÙØ§Ø±Ø§Øª Ø¥Ù†Ø°Ø§Ø± ÙˆÙƒÙˆØ§Ø´Ù Ø¯Ø®Ø§Ù† Ù…ØªÙ‚Ø¯Ù…Ø©
4. Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© - Ø¨ÙˆØ§Ø¨Ø§Øª Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ© Ù…Ø¤Ù…Ù†Ø© Ù„Ù„Ù…Ù†Ø§Ø²Ù„ ÙˆØ§Ù„Ø´Ø±ÙƒØ§Øª
5. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª - Ø´Ø¨ÙƒØ§Øª WiFi Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ­Ù„ÙˆÙ„ Ù„Ù„Ø´Ø±ÙƒØ§Øª
6. ØµÙŠØ§Ù†Ø© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù„Ø§Ø¨ØªÙˆØ¨ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ù†Ø¸Ù…Ø© ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
7. ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© - Ù…ÙˆØ§Ù‚Ø¹ Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¨Ø£Ø­Ø¯Ø« Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
8. Ø­Ù„ÙˆÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ - Ø¯Ù…Ø¬ AI ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª

Ù…Ù…ÙŠØ²Ø§ØªÙ†Ø§:
- Ø®Ø¨Ø±Ø© Ø£ÙƒØ«Ø± Ù…Ù† 15 Ø³Ù†Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ø§Ù„
- Ø£ÙƒØ«Ø± Ù…Ù† 500 Ù…Ø´Ø±ÙˆØ¹ Ù…Ù†Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­
- Ø£ÙƒØ«Ø± Ù…Ù† 1000 Ø¹Ù…ÙŠÙ„ Ø³Ø¹ÙŠØ¯
- Ø¶Ù…Ø§Ù† Ø´Ø§Ù…Ù„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
- Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…Ø³ØªÙ…Ø± 24/7
- Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ©

ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù‡Ø§Ù…Ø©:
- Ø£Ø¬Ø¨ Ø¨Ø´ÙƒÙ„ Ù…Ù‡Ø°Ø¨ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
- Ù‚Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ÙØµÙ„Ø© Ø¹Ù† Ø®Ø¯Ù…Ø§ØªÙ†Ø§
- Ø´Ø¬Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ø£Ùˆ Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ù…Ø®ØµØµ
- ÙƒÙ† Ù…Ø®ØªØµØ±Ø§Ù‹ ÙˆÙ…ÙÙŠØ¯Ø§Ù‹ ÙÙŠ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ
- Ø¥Ø°Ø§ Ø³Ø£Ù„ Ø¹Ù† Ø£Ø³Ø¹Ø§Ø±ØŒ Ø§Ø´Ø±Ø­ Ø£Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§ØµÙØ§ØªØŒ ÙˆÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ù…Ø®ØµØµ
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø´ÙƒÙ„ Ù…Ø¹ØªØ¯Ù„ Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø£ÙƒØ«Ø± ÙˆØ¯ÙŠØ©
- Ø£Ù†Ù‡Ù Ø±Ø¯ÙˆØ¯Ùƒ Ø¨Ø¯Ø¹ÙˆØ© Ù„Ù„ØªÙˆØ§ØµÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©`;

// ============================================
// Middleware
// ============================================
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname)));

// ============================================
// Chat API Endpoint
// ============================================
app.post('/api/chat', async (req, res) => {
    try {
        const { message, history = [] } = req.body;

        if (!message) {
            return res.status(400).json({ error: 'Message is required' });
        }

        // Build messages array for OpenAI
        const messages = [
            { role: 'system', content: SYSTEM_PROMPT }
        ];

        // Add conversation history
        history.forEach(msg => {
            messages.push({
                role: msg.role === 'user' ? 'user' : 'assistant',
                content: msg.content
            });
        });

        // Add current user message
        messages.push({ role: 'user', content: message });

        // Call OpenAI API
        const response = await fetch(OPENAI_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_API_KEY}`
            },
            body: JSON.stringify({
                model: 'gpt-4o-mini', // Ø§Ø³ØªØ®Ø¯Ø§Ù… GPT-4o mini Ù„Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„ÙƒÙØ§Ø¡Ø©
                messages: messages,
                max_tokens: 1024,
                temperature: 0.7,
                presence_penalty: 0.1,
                frequency_penalty: 0.1
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error('OpenAI API Error:', errorData);
            throw new Error(errorData.error?.message || 'OpenAI API error');
        }

        const data = await response.json();
        const aiReply = data.choices[0]?.message?.content || 
            'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨: 0522456676';

        res.json({ 
            reply: aiReply,
            usage: data.usage // Optional: Ù„Ù„ØªØªØ¨Ø¹
        });

    } catch (error) {
        console.error('Chat API Error:', error);
        res.status(500).json({ 
            error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…',
            reply: 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨: 0522456676'
        });
    }
});

// ============================================
// Health Check Endpoint
// ============================================
app.get('/api/health', (req, res) => {
    res.json({ 
        status: 'ok', 
        message: 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø­Ø¯ÙŠØ«Ø© API ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­',
        timestamp: new Date().toISOString()
    });
});

// ============================================
// Serve Frontend
// ============================================
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

// ============================================
// Start Server
// ============================================
app.listen(PORT, () => {
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘                                                            â•‘');
    console.log('â•‘   ðŸš€ Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø­Ø¯ÙŠØ«Ø© - Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!        â•‘');
    console.log('â•‘                                                            â•‘');
    console.log(`â•‘   ðŸ“ Ø§Ù„Ø±Ø§Ø¨Ø·: http://localhost:${PORT}                        â•‘`);
    console.log('â•‘   ðŸ¤– ChatGPT API: Ù…ØªØµÙ„ ÙˆÙ…Ø¤Ù…Ù†                               â•‘');
    console.log('â•‘                                                            â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
});

// ============================================
// Error Handling
// ============================================
process.on('uncaughtException', (error) => {
    console.error('Uncaught Exception:', error);
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason);
});
